<!DOCTYPE html>
<html>

<head>
    <title>Zombie Defense App</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
    <meta charset="UTF-8">
</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/97/three.min.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script src="client/js/bala.js"></script>
    <script src="client/js/jugador.js"></script>
    <script src="client/js/zombie.js"></script>
    <script src="client/js/edificio.js"></script>
    <script src="client/js/casa.js"></script>
    <script src="client/js/escenario.js"></script>
    <script src="client/js/rutas.js"></script>
    <script>
        var scene = new THREE.Scene();
        var aspect = window.innerWidth / window.innerHeight;
        let width = window.innerWidth;
        let height = window.innerHeight;
        let dividedBy = 130;
        //var camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 1000);
        var camera = new THREE.OrthographicCamera(width / - dividedBy, width / dividedBy, height / dividedBy, height / - dividedBy, 1, 10000);
        var renderer = new THREE.WebGLRenderer();
        var loader = new THREE.TextureLoader();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(camera);


        camera.position.z = 10;

        window.addEventListener("wheel", event => {
            const delta = Math.sign(event.wheelDelta);
            dividedBy += delta
            camera.left = width / -dividedBy
            camera.right = width / dividedBy
            camera.top = height / dividedBy
            camera.bottom = height / -dividedBy
            camera.updateProjectionMatrix()
            //console.info(dividedBy);
            //console.info(delta);
        });

        var light = new THREE.AmbientLight(0xb4e7f2);
        scene.add(light);

        jugadores = []
        edificios = []
        casas = []

        zombies = []

        var matriz = crearEscenario();

        var generadorRutas = new GeneradorRutas(matriz);

        var socket = io();

        for (let jugador of jugadores) {
            socket.on('serverMsg', function (data) {
                if (data.msg == "on") {
                    console.log("shot!");
                    jugador.disparar(jugador.getPosY());
                }
                else {
                    console.log(data);
                    var cont = 0;
                    for (let jugador of jugadores) {
                        if (cont == 0) {
                            jugador.setPosY(data.msg);
                            cont++;
                        }
                        else
                            jugador.setPosY2(-data.msg);
                    }
                }
            })
        }


        let contador = 0;

        function limpiar() {
            for (let jugador of jugadores) {
                let balas = [];
                for (let bala of jugador.balas) {
                    if ( !bala.to_destroy ) balas.push(bala);
                }
                jugador.balas = balas;
            }

            let clean_zombies = [];
            for(let zombie of zombies) {
                if (!zombie.to_destroy) clean_zombies.push(zombie);
            }
            zombies = clean_zombies;
        }

        var render = function () {
            requestAnimationFrame(render);

            if( contador % 100 == 0){
                zombies.push( new Zombie(generadorRutas.generarRutaZombie()) );
                jugadores[0].disparar(0);
            }
            

            for(let zombie of zombies) {
                zombie.actualizar();
            }


            // Buscar collisiones de balas
            for (let jugador of jugadores) {
                for (let bala of jugador.balas) {
                    for (let zombie of zombies) {
                        if (zombie.colision(bala.cube.position.x,bala.cube.position.y)) zombie.destruir();  
                    }
                    
                }

                jugador.actualizar()
            }

            limpiar();

            renderer.render(scene, camera);
            
            contador++;
        };
        render();


    </script>
</body>

</html>